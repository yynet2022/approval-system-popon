# ポポン（承認システム） 総合テスト仕様書

**Version**: 1.0
**対象バージョン**: ver 4.1
**作成日**: 2025/12/30

---

## 1. はじめに

### 1.1 目的
本ドキュメントは、承認システム「ポポン」の機能が仕様通りに動作し、業務利用に耐えうる品質であることを確認するためのテスト手順と期待値を定義するものです。

### 1.2 テスト対象範囲
*   Webブラウザを通じたユーザーインターフェース（PCブラウザ想定）
*   申請から承認完了までのワークフロー
*   メール通知（宛先、内容の正確性）
*   権限管理とアクセス制御

### 1.3 テスト環境・前提条件
テスト実施前に、以下のユーザーアカウントを作成し、ログイン可能な状態にしておくこと。

| 役割名 | ユーザー名 (例) | メールアドレス (例) | 権限設定 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **申請者** | User-Applicant | `applicant@example.com` | なし | 一般ユーザー |
| **承認者A** | User-Approver-A | `approver_a@example.com` | `is_approver=True` | 第一承認者役 |
| **承認者B** | User-Approver-B | `approver_b@example.com` | `is_approver=True` | 第二承認者役 |
| **承認者C** | User-Approver-C | `approver_c@example.com` | `is_approver=True` | 最終承認者役 |
| **管理者** | User-Admin | `admin@example.com` | `is_staff=True` | システム管理者 |

※ メール送信はコンソール出力、または開発用SMTPサーバー（MailHog等）で確認することを想定。

---

## 2. テストケース一覧

### TS1: 認証・アカウント管理

| ID | 項目 | 手順 | 期待される動作 | 確認 |
| :--- | :--- | :--- | :--- | :--- |
| **1-01** | **ログイン (未登録)** | 1. ログアウト状態で `/accounts/login/` にアクセス。<br>2. 未登録のメールアドレスを入力して送信。 | 1. 「メールを送信しました」画面が表示される。<br>2. システム内で新規ユーザーが作成される。<br>3. ログインURL記載のメールが送信される。 | □ |
| **1-02** | **ログイン (登録済)** | 1. `/accounts/login/` にアクセス。<br>2. `applicant@example.com` を入力して送信。 | 1. 「メールを送信しました」画面が表示される。<br>2. ログインURL記載のメールが送信される。 | □ |
| **1-03** | **トークン認証** | 1. 受信したメールのログインURLをクリック。 | 1. 自動的にログイン状態になり、ポータルトップ (`/`) へ遷移する。<br>2. ヘッダーにユーザー名が表示される。 | □ |
| **1-04** | **トークン再利用 (エラー)** | 1. **1-03**で使用したURLを再度クリック。 | 1. 「無効なリンクか、有効期限切れです」というエラー画面が表示される。 | □ |
| **1-05** | **ログアウト** | 1. ヘッダーの「ログアウト」をクリック。 | 1. ログアウトされ、ポータルトップへ遷移する。<br>2. ヘッダーが「ログイン」表示に戻る。 | □ |
| **1-06** | **アクセス制御** | 1. 未ログイン状態で `/approvals/create/simple/` (申請作成画面) に直接アクセス。 | 1. ログイン画面、または403 Forbidden画面が表示される（ログイン必須画面へのアクセス禁止）。 | □ |

### TS2: ポータル・検索機能

**前提**: 申請者でログイン中。事前にいくつかの申請データ（自分用、他人用）が存在すること。

| ID | 項目 | 手順 | 期待される動作 | 確認 |
| :--- | :--- | :--- | :--- | :--- |
| **2-01** | **一覧表示** | 1. トップページ (`/`) を表示。 | 1. 「全申請一覧」に申請が表示される。<br>2. `is_restricted=True` (閲覧制限) の他人の申請が表示されていないこと。 | □ |
| **2-02** | **検索機能** | 1. 検索窓に特定の「申請番号」または「件名」を入力して検索。 | 1. 該当する申請のみがリストに表示される。 | □ |
| **2-03** | **フィルタ (自分の申請)** | 1. 「自分の申請のみ表示」トグルをONにする。 | 1. 申請者が自分のデータのみが表示される。 | □ |
| **2-04** | **ステータスフィルタ** | 1. ステータスプルダウンで「承認完了」を選択。 | 1. ステータスが「Approved」の申請のみが表示される。 | □ |
| **2-05** | **ページネーション (申請)** | 1. データ数が21件以上ある状態で、一覧下部の「次へ」をクリック。 | 1. 画面遷移せず、Ajaxでリストが次のページの内容に更新される。 | □ |
| **2-06** | **ページネーション (お知らせ)** | 1. **公開日時(published_at)が現在時刻以前**のお知らせが6件以上ある状態で、お知らせエリア下部の「次へ」をクリック。 | 1. 画面遷移せず、Ajaxでお知らせリストが次のページの内容に更新される。 | □ |
| **2-07** | **ダッシュボード表示** | 1. 自分が承認担当になっている申請がある状態でトップを表示。 | 1. 「承認依頼」エリアに該当の申請が表示される。 | □ |

### TS3: 申請作成・承認ルート設定

**前提**: 申請者でログイン中。

| ID | 項目 | 手順 | 期待される動作 | 確認 |
| :--- | :--- | :--- | :--- | :--- |
| **3-01** | **簡易申請画面表示** | 1. 「新規申請」>「簡易申請」を選択。 | 1. 簡易申請用フォーム（件名、内容、閲覧制限、承認者設定）が表示される。 | □ |
| **3-02** | **承認者追加** | 1. 承認者設定エリアの「＋」ボタンをクリック。 | 1. 入力枠が増える（最大5枠まで確認）。 | □ |
| **3-03** | **承認者検索** | 1. 承認者入力欄で `approver` と入力。 | 1. オートコンプリートで候補が表示される。<br>2. 自分自身（申請者）は候補に出ない、または選択できないこと。 | □ |
| **3-04** | **バリデーション (必須)** | 1. 件名のみ入力し、承認者を空のまま「申請する」をクリック。 | 1. エラーメッセージ「承認者を少なくとも1名指定してください」が表示される。 | □ |
| **3-05** | **バリデーション (自分)** | 1. 承認者に自分自身を指定して申請（HTML操作等で無理やり入力した場合）。 | 1. エラーメッセージ「申請者本人を承認者に含めることはできません」が表示される。 | □ |
| **3-06** | **バリデーション (連続)** | 1. 承認者1: 承認者A<br>2. 承認者2: 承認者A<br>とし、「申請する」をクリック。 | 1. エラーメッセージ「同じ承認者を連続して設定することはできません」が表示される。 | □ |
| **3-07** | **申請実行 (正常)** | 1. 件名: `Test Request`<br>2. 承認者1: 承認者A<br>3. 承認者2: 承認者B<br>として「申請する」をクリック。 | 1. 申請完了メッセージが表示され、トップへ遷移する。<br>2. ステータスが「Pending (申請中)」になる。<br>3. **承認者A** に「承認依頼メール」が送信される。 | □ |
| **3-08** | **出張申請 (種別確認)** | 1. 「新規申請」>「近距離出張申請」を選択。<br>2. 日程、行先を入力して申請。 | 1. 出張申請として正常に登録される。<br>2. 申請番号プレフィックスが `REQ-L-` となる。 | □ |

### TS4: 承認プロセス (正常系 - 全承認)

**前提**: **TS3-07** で作成した申請（承認ルート: A -> B）を使用。

| ID | 項目 | 手順 | 期待される動作 | 確認 |
| :--- | :--- | :--- | :--- | :--- |
| **4-01** | **詳細表示 (承認者A)** | 1. **承認者A** でログイン。<br>2. トップの「承認依頼」から当該申請をクリック。 | 1. 申請詳細画面が表示される。<br>2. 「承認」「差戻」「却下」ボタンが表示される。 | □ |
| **4-02** | **一次承認実行** | 1. コメント欄に「承認します」と入力。<br>2. 「承認」ボタンをクリック。 | 1. 「承認しました」メッセージが表示される。<br>2. ステータスは「Pending」のまま、現在のステップが 2 に進む。<br>3. **承認者B** に「承認依頼メール」が送信される。 | □ |
| **4-03** | **詳細表示 (承認者B)** | 1. **承認者B** でログイン。<br>2. 当該申請の詳細を開く。 | 1. 承認者Aのコメントと承認日時が表示されている。<br>2. アクションボタンが表示される。 | □ |
| **4-04** | **最終承認実行** | 1. 「承認」ボタンをクリック。 | 1. 「承認しました」メッセージが表示される。<br>2. 申請全体のステータスが「Approved (承認完了)」になる。<br>3. **申請者**、**承認者A**、**承認者B** 全員に「承認完了メール」が送信される。 | □ |
| **4-05** | **事後確認** | 1. 再度詳細画面を開く。 | 1. アクションボタンが消えている（却下ボタンのみ条件付きで残る場合あり）。<br>2. 「承認完了」バッジが表示されている。 | □ |

### TS5: 承認プロセス (異常系・変更)

**前提**: 新規申請を作成（ルート: A -> B）。

| ID | 項目 | 手順 | 期待される動作 | 確認 |
| :--- | :--- | :--- | :--- | :--- |
| **5-01** | **差戻し (Remand)** | 1. **承認者A** でログインし、当該申請を開く。<br>2. コメントを入力せず「差戻」をクリック。<br>3. コメントを入力して「差戻」をクリック。 | 2. エラー「差戻しの場合はコメントが必須です」。<br>3. ステータスが「Remanded (差戻)」になる。<br>4. **申請者** に「差戻しメール」が送信される。 | □ |
| **5-02** | **再申請 (Resubmit)** | 1. **申請者** でログイン。<br>2. トップの「差戻し案件」から当該申請を開く。<br>3. 「再申請」ボタンをクリック (編集画面へ)。<br>4. 内容を修正し、承認者を **承認者C** に変更して「再申請」をクリック。 | 1. ステータスが「Pending」に戻る。<br>2. 承認ルートがリセットされ、Cのみになる。<br>3. **承認者C** に「再承認依頼メール」が送信される。<br>4. 履歴ログに「再申請」が記録される。 | □ |
| **5-03** | **却下 (Reject)** | 1. **承認者C** でログイン。<br>2. コメントを入力して「却下」をクリック。 | 1. ステータスが「Rejected (却下)」になる。<br>2. **申請者** に「却下メール」が送信される。<br>3. これ以降、再申請や承認操作ができないこと。 | □ |
| **5-04** | **取り下げ (Withdraw)** | 1. 新規申請を作成 (申請者 -> A)。<br>2. **承認者A** が承認する前に、**申請者** が詳細画面を開く。<br>3. 「取り下げ」ボタンをクリック。 | 1. ステータスが「Withdrawn (取り下げ)」になる。<br>2. **承認者A** (現在の担当者) に「取り下げ通知メール」が送信される。 | □ |
| **5-05** | **事後却下** | 1. 承認完了(Approved)した案件を、ルートに含まれていた承認者で開く。<br>2. 「却下」ボタンが表示されていることを確認し、実行。 | 1. ステータスが「Rejected」に変更される。<br>2. 関係者全員に却下メールが飛ぶ。 | □ |

### TS6: 管理者機能・権限

**前提**: **管理者** (`is_staff=True`) でログイン。

| ID | 項目 | 手順 | 期待される動作 | 確認 |
| :--- | :--- | :--- | :--- | :--- |
| **6-01** | **管理サイト** | 1. `/admin/` にアクセス。 | 1. Django管理サイトが表示される。<br>2. Users, Requests, Notifications 等の管理が可能。 | □ |
| **6-02** | **代理差戻し** | 1. 承認待ち(Pending)の状態の他人の申請を詳細画面で開く。<br>2. 「【管理者用】代理差戻し」エリアが表示される。<br>3. コメントを入力して実行。 | 1. 強制的にステータスが「Remanded」になる。<br>2. 履歴ログに「ProxyRemand」が記録される。<br>3. 申請者と現承認者に通知が飛ぶ。 | □ |
| **6-03** | **閲覧制限の確認** | 1. **申請者** が `is_restricted=True` で申請を作成。<br>2. 無関係なユーザー（承認ルート外）で詳細URLに直接アクセス。 | 1. 「権限がありません」エラー、または403 Forbidden。<br>2. **管理者** であれば閲覧可能であること（特権）。 | □ |

---
**テスト実施者**: ____________________
**実施日**: ____/____/____
